/**
 * Drag/rotate/resize handler for [leaflet](http://leafletjs.com) rectangles.
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *
 * @author Simon Pigot <simon.pigot@csiro.au>
 * @license MIT
 * @preserve
 */
L.RectangleTransform={};L.RectangleTransform.pointOnLine=function(t,e,a){var n=1+a/t.distanceTo(e);return new L.Point(t.x+(e.x-t.x)*n,t.y+(e.y-t.y)*n)};L.RectangleTransform.merge=function(){var t=1;var e,a;var n=arguments[t];function i(t){return Object.prototype.toString.call(t)==="[object Object]"}var r=arguments[0];while(n){n=arguments[t++];for(e in n){if(!n.hasOwnProperty(e)){continue}a=n[e];if(i(a)&&i(r[e])){r[e]=L.Util.merge(r[e],a)}else{r[e]=a}}}return r};L.Matrix=function(t,e,a,n,i,r){this._matrix=[t,e,a,n,i,r]};L.Matrix.prototype={transform:function(t){return this._transform(t.clone())},_transform:function(t){var e=this._matrix;var a=t.x,n=t.y;t.x=e[0]*a+e[1]*n+e[4];t.y=e[2]*a+e[3]*n+e[5];return t},untransform:function(t){var e=this._matrix;return new L.Point((t.x/e[0]-e[4])/e[0],(t.y/e[2]-e[5])/e[2])},clone:function(){var t=this._matrix;return new L.Matrix(t[0],t[1],t[2],t[3],t[4],t[5])},translate:function(t){if(t===undefined){return new L.Point(this._matrix[4],this._matrix[5])}var e,a;if(typeof t==="number"){e=a=t}else{e=t.x;a=t.y}return this._add(1,0,0,1,e,a)},scale:function(t,e){if(t===undefined){return new L.Point(this._matrix[0],this._matrix[3])}var a,n;e=e||L.point(0,0);if(typeof t==="number"){a=n=t}else{a=t.x;n=t.y}return this._add(a,0,0,n,e.x,e.y)._add(1,0,0,1,-e.x,-e.y)},rotate:function(t,e){var a=Math.cos(t);var n=Math.sin(t);e=e||new L.Point(0,0);return this._add(a,n,-n,a,e.x,e.y)._add(1,0,0,1,-e.x,-e.y)},flip:function(){this._matrix[1]*=-1;this._matrix[2]*=-1;return this},_add:function(t,e,a,n,i,r){var s=[[],[],[]];var o=this._matrix;var h=[[o[0],o[2],o[4]],[o[1],o[3],o[5]],[0,0,1]];var l=[[t,a,i],[e,n,r],[0,0,1]],c;if(t&&t instanceof L.Matrix){o=t._matrix;l=[[o[0],o[2],o[4]],[o[1],o[3],o[5]],[0,0,1]]}for(var g=0;g<3;g++){for(var _=0;_<3;_++){c=0;for(var f=0;f<3;f++){c+=h[g][f]*l[f][_]}s[g][_]=c}}this._matrix=[s[0][0],s[1][0],s[0][1],s[1][1],s[0][2],s[1][2]];return this}};L.matrix=function(t,e,a,n,i,r){return new L.Matrix(t,e,a,n,i,r)};L.Handler.RectangleTransform=L.Handler.extend({options:{angle:0,ni:0,nj:0,dphi:0,dlambda:0,scaleHandleOptions:{radius:5,fillColor:"#ffffff",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:true},scaleOriginHandleOptions:{radius:10,fillColor:"#ffffff",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:true},rotateHandleOptions:{radius:7,fillColor:"#dddddd",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:false},rotateLineOptions:{stroke:true,color:"#000000",weight:1,opacity:1,dashArray:[3,3],fill:false},handleClass:L.CircleMarker,cursorsByType:{ne:"nesw-resize",nw:"nwse-resize",sw:"nesw-resize",se:"nwse-resize",e:"e-resize",s:"s-resize",n:"n-resize",w:"w-resize"}},initialize:function(t){this.rectangle_=t;this.map_=t._map;this.controlFeatures_=null;this.enabled_=false;this.toRadians=function(t){return t*Math.PI/180};this.toDegrees=function(t){return t*180/Math.PI};this.dphi_=this.dlambda_=this.ni_=this.nj_=0;this.twoPIR=2*Math.PI*6371},enable:function(t){if(this.rectangle_._map){this.map_=this.rectangle_._map;if(t){this.setOptions(t)}L.Handler.prototype.enable.call(this)}},setOptions:function(t){var e=this.enabled_;if(e){this.disable()}this.options=L.RectangleTransform.merge({},L.Handler.RectangleTransform.prototype.options,t);if(t.angle){this.angle_=this.toRadians(-t.angle)}if(t.dphi){this.dphi_=t.dphi}if(t.dlambda){this.dlambda_=t.dlambda}if(t.ni){this.ni_=t.ni}if(t.nj){this.nj_=t.nj}if(e){this.enable()}return this},addHooks:function(){if(!this.anchor_){this.setAnchor(this.rectangle_.getBounds().getSouthWest())}if(!this.angle_){this.angle_=0}else{this.rotate_(this.rectangle_,this.angle_,this.getAnchor())}this.createOrUpdateControlFeatures_();this.rectangle_.on("mousedown",this.onTranslateStart_,this)},removeHooks:function(){this.hideHandlers_();this.rectangle_.off("mousedown",this.onTranslateStart_,this);this.controlFeatures_=null;this.rectangle_=null;this.gridFeature_=null},setAnchor:function(t){this.anchor_=t},setAngle:function(t){this.angle_=t},setGridCharacteristics:function(t,e,a,n){this.ni_=t;this.nj_=e;this.dphi_=a;this.dlambda_=n},getAnchor:function(){return this.anchor_},getAngle:function(){return this.angle_},cloneLatLngs:function(t){var e=[];for(var a=0;a<t.length;a++){var n=t[a];if(Array.isArray(n)){var i=this.cloneLatLngs(n);e.push(i)}else{e.push({lat:n.lat,lng:n.lng})}}return e},destinationPoint:function(t,e,a){var n=6371;var i=this.toRadians(e);var r=this.toRadians(t.lat),s=this.toRadians(t.lng);var o=Math.asin(Math.sin(r)*Math.cos(a/n)+Math.cos(r)*Math.sin(a/n)*Math.cos(i));var h=s+Math.atan2(Math.sin(i)*Math.sin(a/n)*Math.cos(r),Math.cos(a/n)-Math.sin(r)*Math.sin(o));return L.latLng([this.toDegrees(o),this.toDegrees(h)])},calcdlambdakm:function(t,e){var a=Math.abs(t)*Math.PI/180;return this.twoPIR*Math.cos(a)*(e/360)},calcdphikm:function(t){return this.twoPIR*(t/360)},createRealFeature:function(t){if(this.dphi_===0||this.dlambda_===0||this.ni_===0||this.nj_===0){return false}var e=this.ni_*this.calcdlambdakm(t.lat,this.dlambda_),a=this.nj_*this.calcdphikm(this.dphi_),n=this.destinationPoint(t,0,a),i=this.ni_*this.calcdlambdakm(n.lat,this.dlambda_),r=this.destinationPoint(n,90,i),s=this.destinationPoint(t,90,e);return new L.Polygon([t,n,r,s,t])},createOrUpdateControlFeatures_:function(){if(this.controlFeatures_){this.map_.removeLayer(this.controlFeatures_)}var t=new L.Polygon(this.cloneLatLngs(this.rectangle_.getLatLngs()));if(this.getAngle()!==0){this.rotate_(t,-1*this.getAngle(),this.getAnchor())}var e=t.getBounds();var a=e.getNorthWest(),n=e.getNorthEast(),i=e.getSouthWest(),r=e.getSouthEast(),s=e.getCenter();var o=this.createHandler_(a,"nw"),h=this.createHandler_(n,"ne"),l=this.createHandler_(i,"sw","origin"),c=this.createHandler_(r,"se"),g=this.createHandler_(L.latLng(i.lat,s.lng),"s"),_=this.createHandler_(L.latLng(a.lat,s.lng),"n"),f=this.createHandler_(L.latLng(s.lat,r.lng),"e"),u=this.createHandler_(L.latLng(s.lat,i.lng),"w"),d=this.createHandler_(L.latLng(i.lat,i.lng-(s.lng-i.lng)),"rotate","rotate"),m=new L.Polyline([L.latLng(i.lat,i.lng-(s.lng-i.lng)),i],this.options.rotateLineOptions);this.controlFeatures_=new L.FeatureGroup([m,o,h,l,c,u,_,f,g,d]);if(this.getAngle()!==0){this.rotate_(this.controlFeatures_,this.getAngle(),this.getAnchor())}this.map_.addLayer(this.controlFeatures_)},createHandler_:function(t,e,a){var n=this.options.handleClass;var i;if(a==="rotate"){i=this.options.rotateHandleOptions}else if(a==="origin"){i=this.options.scaleOriginHandleOptions}else{i=this.options.scaleHandleOptions}var r=new n(t,L.Util.extend({},i,{id:e,className:this.options.cursorsByType[e]+"-webtrike"}));if(a==="rotate"){r.on("mousedown",this.onRotateStart_,this)}else{r.on("mousedown",this.onScaleStart_,this)}return r},rotate_:function(t,e,a){var n=L.matrix(1,0,0,1,0,0);n=n.rotate(e,this.project_(a)).flip();if(t instanceof L.FeatureGroup){t.eachLayer(function(t){this.transformLayer_(t,n)},this)}else{this.transformLayer_(t,n)}},translate_:function(t,e){var a=L.matrix(1,0,0,1,0,0);a=a.translate(e);this.transformLayer_(t,a)},transformLayer_:function(t,e){var a;if(t.getLatLngs){a=t.getLatLngs()}else if(t.getLatLng){a=[t.getLatLng()]}else{a=[t]}a=this.transformArray_(a,e);if(t.setLatLngs){t.setLatLngs(a)}else if(t.setLatLng){t.setLatLng(a[0])}else{t.lat=a[0].lat;t.lng=a[0].lng}},transformArray_:function(t,e){for(var a=0;a<t.length;a++){var n=t[a];if(Array.isArray(n)){n=this.transformArray_(n,e)}else{var i=e.transform(this.project_(n));var r=this.unproject_(i);n.lat=r.lat;n.lng=r.lng}}return t},project_:function(t){return L.Projection.SphericalMercator.project(t)},unproject_:function(t){return L.Projection.SphericalMercator.unproject(t)},onRotateStart_:function(t){var e=this.map_;e.dragging.disable();this.previous_=t.layerPoint;e.on("mousemove",this.onRotate_,this).on("mouseup",this.onRotateEnd_,this);this.rectangle_.fire("rotatestart",{layer:this.rectangle_,rotation:this.angle_})},onRotate_:function(t){var e=this.map_;var a=t.layerPoint;var n=this.previous_;e.dragging.disable();var i=e.latLngToLayerPoint(this.getAnchor());if(n){var r=Math.atan2(a.y-i.y,a.x-i.x)-Math.atan2(n.y-i.y,n.x-i.x);this.setAngle(this.angle_-r);this.previous_=a;this.rotate_(this.rectangle_,-r,this.getAnchor());this.createOrUpdateControlFeatures_(true)}this.rectangle_.fire("rotate",{layer:this.rectangle_,rotation:this.angle_})},onRotateEnd_:function(t){var e=this.map_;e.off("mousemove",this.onRotate_,this).off("mouseup",this.onRotateEnd_,this);this.rectangle_.fire("rotateend",{layer:this.rectangle_,rotation:this.angle_})},onScaleStart_:function(t){var e=t.target;var a=this.map_;a.dragging.disable();this.lastCoordinate_=t.latlng;this.activeMarker_=e;this.map_.on("mousemove",this.onScale_,this).on("mouseup",this.onScaleEnd_,this);this.rectangle_.fire("scalestart",{layer:this.rectangle_})},onScale_:function(t){var e=t.latlng;var a,n,i=this.activeMarker_.options["id"];if(this.getAngle()!==0){this.rotate_(this.rectangle_,-1*this.getAngle(),this.getAnchor())}var r=new L.Marker(e);if(this.getAngle()!==0){this.rotate_(r,-1*this.getAngle(),this.getAnchor())}e=r.getLatLng();var s=this.rectangle_.getBounds();var o=s.getSouthWest(),h=s.getNorthEast();if(i==="s"){n=Math.min(e.lat,s.getNorth());o.lat=n}else if(i==="n"){n=Math.max(e.lat,s.getSouth());h.lat=n}else if(i==="e"){a=Math.max(e.lng,s.getWest());h.lng=a}else if(i==="w"){a=Math.min(e.lng,s.getEast());o.lng=a}else if(i==="nw"){a=Math.min(e.lng,s.getEast());n=Math.max(e.lat,s.getSouth());o.lng=a;h.lat=n}else if(i==="ne"){a=Math.max(e.lng,s.getWest());n=Math.max(e.lat,s.getSouth());h.lng=a;h.lat=n}else if(i==="se"){a=Math.max(e.lng,s.getWest());n=Math.min(e.lat,s.getNorth());h.lng=a;o.lat=n}this.rectangle_.setBounds(L.latLngBounds(o,h));if(this.getAngle()!==0){this.rotate_(this.rectangle_,this.getAngle(),this.getAnchor())}this.setAnchor(o);this.createOrUpdateControlFeatures_();this.rectangle_.fire("scale",{layer:this.rectangle_,anchor:this.anchor_})},onScaleEnd_:function(t){this.map_.off("mousemove",this._onScale,this).off("mouseup",this._onScaleEnd,this);this.rectangle_.fire("scaleend",{layer:this._rectangle})},hideHandlers_:function(){this.map_.removeLayer(this.controlFeatures_)},onTranslateStart_:function(t){var e=this.map_;e.dragging.disable();this.lastCoordinate_=t.latlng;this.map_.on("mousemove",this.onTranslate_,this).on("mouseup",this.onTranslateEnd_,this);this.rectangle_.fire("translatestart",{layer:this.rectangle_})},onTranslate_:function(t){var e=t.latlng;if(this.lastCoordinate_){var a=this.project_(e);var n=this.project_(this.lastCoordinate_);var i=new L.Point(a.x-n.x,a.y-n.y);this.translate_(this.rectangle_,i);var r=this.getAnchor();this.translate_(r,i);this.setAnchor(r);this.createOrUpdateControlFeatures_();this.lastCoordinate_=e}this.rectangle_.fire("translate",{layer:this.rectangle_,anchor:this.getAnchor()})},onTranslateEnd_:function(t){this.map_.off("mousemove",this._onTranslate,this).off("mouseup",this._onTranslateEnd,this);this.rectangle_.fire("translateend",{layer:this._rectangle});this.rectangle_.on("mousedown",this.onTranslateStart_,this)}});L.Path.addInitHook(function(){if(this.options.transform){this.transform=new L.Handler.RectangleTransform(this,this.options.transform)}});