/**
 * Drag/rotate/resize handler for [leaflet](http://leafletjs.com) rectangles.
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *
 * @author Simon Pigot <simon.pigot@csiro.au>
 * @license MIT
 * @preserve
 */
L.RectangleTransform={};L.RectangleTransform.pointOnLine=function(t,e,n){var a=1+n/t.distanceTo(e);return new L.Point(t.x+(e.x-t.x)*a,t.y+(e.y-t.y)*a)};L.RectangleTransform.merge=function(){var t=1;var e,n;var a=arguments[t];function r(t){return Object.prototype.toString.call(t)==="[object Object]"}var i=arguments[0];while(a){a=arguments[t++];for(e in a){if(!a.hasOwnProperty(e)){continue}n=a[e];if(r(n)&&r(i[e])){i[e]=L.Util.merge(i[e],n)}else{i[e]=n}}}return i};L.Matrix=function(t,e,n,a,r,i){this._matrix=[t,e,n,a,r,i]};L.Matrix.prototype={transform:function(t){return this._transform(t.clone())},_transform:function(t){var e=this._matrix;var n=t.x,a=t.y;t.x=e[0]*n+e[1]*a+e[4];t.y=e[2]*n+e[3]*a+e[5];return t},untransform:function(t){var e=this._matrix;return new L.Point((t.x/e[0]-e[4])/e[0],(t.y/e[2]-e[5])/e[2])},clone:function(){var t=this._matrix;return new L.Matrix(t[0],t[1],t[2],t[3],t[4],t[5])},translate:function(t){if(t===undefined){return new L.Point(this._matrix[4],this._matrix[5])}var e,n;if(typeof t==="number"){e=n=t}else{e=t.x;n=t.y}return this._add(1,0,0,1,e,n)},scale:function(t,e){if(t===undefined){return new L.Point(this._matrix[0],this._matrix[3])}var n,a;e=e||L.point(0,0);if(typeof t==="number"){n=a=t}else{n=t.x;a=t.y}return this._add(n,0,0,a,e.x,e.y)._add(1,0,0,1,-e.x,-e.y)},rotate:function(t,e){var n=Math.cos(t);var a=Math.sin(t);e=e||new L.Point(0,0);return this._add(n,a,-a,n,e.x,e.y)._add(1,0,0,1,-e.x,-e.y)},flip:function(){this._matrix[1]*=-1;this._matrix[2]*=-1;return this},_add:function(t,e,n,a,r,i){var s=[[],[],[]];var o=this._matrix;var l=[[o[0],o[2],o[4]],[o[1],o[3],o[5]],[0,0,1]];var h=[[t,n,r],[e,a,i],[0,0,1]],c;if(t&&t instanceof L.Matrix){o=t._matrix;h=[[o[0],o[2],o[4]],[o[1],o[3],o[5]],[0,0,1]]}for(var g=0;g<3;g++){for(var _=0;_<3;_++){c=0;for(var f=0;f<3;f++){c+=l[g][f]*h[f][_]}s[g][_]=c}}this._matrix=[s[0][0],s[1][0],s[0][1],s[1][1],s[0][2],s[1][2]];return this}};L.matrix=function(t,e,n,a,r,i){return new L.Matrix(t,e,n,a,r,i)};L.Handler.RectangleTransform=L.Handler.extend({options:{angle:0,anchor:new L.Point,scaleHandleOptions:{radius:5,fillColor:"#ffffff",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:true},scaleOriginHandleOptions:{radius:10,fillColor:"#ffffff",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:true},rotateHandleOptions:{radius:7,fillColor:"#dddddd",color:"#202020",fillOpacity:1,weight:2,opacity:.7,setCursor:false},rotateLineOptions:{stroke:true,color:"#000000",weight:1,opacity:1,dashArray:[3,3],fill:false},handleClass:L.CircleMarker,cursorsByType:{ne:"nesw-resize",nw:"nwse-resize",sw:"nesw-resize",se:"nwse-resize",e:"e-resize",s:"s-resize",n:"n-resize",w:"w-resize"}},initialize:function(t){this.rectangle_=t;this.map_=t._map;this.controlFeatures_=null;this.enabled_=false},enable:function(t){if(this.rectangle_._map){this.map_=this.rectangle_._map;if(t){this.setOptions(t)}L.Handler.prototype.enable.call(this)}},setOptions:function(t){var e=this.enabled_;if(e){this.disable()}this.options=L.RectangleTransform.merge({},L.Handler.RectangleTransform.prototype.options,t);if(e){this.enable()}return this},addHooks:function(){if(!this.anchor_){this.setAnchor(this.rectangle_.getBounds().getSouthWest())}if(!this.angle_){this.angle_=0;if(this.rectangle_.options.rotation){this.angle_=this.rectangle_.options.rotation;this.rotate_(this.rectangle_,this.angle_,this.getAnchor())}}this.createOrUpdateControlFeatures_();this.rectangle_.on("mousedown",this.onTranslateStart_,this)},removeHooks:function(){this.hideHandlers_();this.rectangle_.off("mousedown",this.onTranslateStart_,this);this.controlFeatures_=null;this.rectangle_=null},setAnchor:function(t){this.anchor_=t},getAnchor:function(){return this.anchor_},setAngle:function(t){this.angle_=t},getAngle:function(){return this.angle_},cloneLatLngs:function(t){var e=[];for(var n=0;n<t.length;n++){var a=t[n];if(Array.isArray(a)){var r=this.cloneLatLngs(a);e.push(r)}else{e.push({lat:a.lat,lng:a.lng})}}return e},createOrUpdateControlFeatures_:function(){if(this.controlFeatures_){this.map_.removeLayer(this.controlFeatures_)}var t=new L.Polygon(this.cloneLatLngs(this.rectangle_.getLatLngs()));if(this.getAngle()!==0){this.rotate_(t,-1*this.getAngle(),this.getAnchor())}var e=t.getBounds();var n=e.getNorthWest(),a=e.getNorthEast(),r=e.getSouthWest(),i=e.getSouthEast(),s=e.getCenter();var o=this.createHandler_(n,"nw"),l=this.createHandler_(a,"ne"),h=this.createHandler_(r,"sw","origin"),c=this.createHandler_(i,"se"),g=this.createHandler_(L.latLng(r.lat,s.lng),"s"),_=this.createHandler_(L.latLng(n.lat,s.lng),"n"),f=this.createHandler_(L.latLng(s.lat,i.lng),"e"),u=this.createHandler_(L.latLng(s.lat,r.lng),"w"),d=this.createHandler_(L.latLng(r.lat,r.lng-(s.lng-r.lng)),"rotate","rotate"),m=new L.Polyline([L.latLng(r.lat,r.lng-(s.lng-r.lng)),r],this.options.rotateLineOptions);this.controlFeatures_=new L.FeatureGroup([m,o,l,h,c,u,_,f,g,d]);if(this.getAngle()!==0){this.rotate_(this.controlFeatures_,this.getAngle(),this.getAnchor())}this.map_.addLayer(this.controlFeatures_)},createHandler_:function(t,e,n){var a=this.options.handleClass;var r;if(n==="rotate"){r=this.options.rotateHandleOptions}else if(n==="origin"){r=this.options.scaleOriginHandleOptions}else{r=this.options.scaleHandleOptions}var i=new a(t,L.Util.extend({},r,{id:e,className:this.options.cursorsByType[e]+"-webtrike"}));if(n==="rotate"){i.on("mousedown",this.onRotateStart_,this)}else{i.on("mousedown",this.onScaleStart_,this)}return i},rotate_:function(t,e,n){var a=L.matrix(1,0,0,1,0,0);a=a.rotate(e,this.project_(n)).flip();if(t instanceof L.FeatureGroup){t.eachLayer(function(t){this.transformLayer_(t,a)},this)}else{this.transformLayer_(t,a)}},translate_:function(t,e){var n=L.matrix(1,0,0,1,0,0);n=n.translate(e);this.transformLayer_(t,n)},transformLayer_:function(t,e){var n;if(t.getLatLngs){n=t.getLatLngs()}else if(t.getLatLng){n=[t.getLatLng()]}else{n=[t]}n=this.transformArray_(n,e);if(t.setLatLngs){t.setLatLngs(n)}else if(t.setLatLng){t.setLatLng(n[0])}else{t.lat=n[0].lat;t.lng=n[0].lng}},transformArray_:function(t,e){for(var n=0;n<t.length;n++){var a=t[n];if(Array.isArray(a)){a=this.transformArray_(a,e)}else{var r=e.transform(this.project_(a));var i=this.unproject_(r);a.lat=i.lat;a.lng=i.lng}}return t},project_:function(t){return L.Projection.SphericalMercator.project(t)},unproject_:function(t){return L.Projection.SphericalMercator.unproject(t)},onRotateStart_:function(t){var e=this.map_;e.dragging.disable();this.previous_=t.layerPoint;e.on("mousemove",this.onRotate_,this).on("mouseup",this.onRotateEnd_,this);this.rectangle_.fire("rotatestart",{layer:this.rectangle_,rotation:this.angle_})},onRotate_:function(t){var e=this.map_;var n=t.layerPoint;var a=this.previous_;e.dragging.disable();var r=e.latLngToLayerPoint(this.getAnchor());if(a){var i=Math.atan2(n.y-r.y,n.x-r.x)-Math.atan2(a.y-r.y,a.x-r.x);this.setAngle(this.angle_+i);this.previous_=n;this.rotate_(this.rectangle_,i,this.getAnchor());this.createOrUpdateControlFeatures_(true)}this.rectangle_.fire("rotate",{layer:this.rectangle_,rotation:this.angle_})},onRotateEnd_:function(t){var e=this.map_;e.off("mousemove",this.onRotate_,this).off("mouseup",this.onRotateEnd_,this);this.rectangle_.fire("rotateend",{layer:this.rectangle_,rotation:this.angle_})},onScaleStart_:function(t){var e=t.target;var n=this.map_;n.dragging.disable();this.lastCoordinate_=t.latlng;this.activeMarker_=e;this.map_.on("mousemove",this.onScale_,this).on("mouseup",this.onScaleEnd_,this);this.rectangle_.fire("scalestart",{layer:this.rectangle_})},onScale_:function(t){var e=t.latlng;var n,a,r=this.activeMarker_.options["id"];if(this.getAngle()!==0){this.rotate_(this.rectangle_,-1*this.getAngle(),this.getAnchor())}var i=new L.Marker(e);if(this.getAngle()!==0){this.rotate_(i,-1*this.getAngle(),this.getAnchor())}e=i.getLatLng();var s=this.rectangle_.getBounds();var o=s.getSouthWest(),l=s.getNorthEast();if(r==="s"){a=Math.min(e.lat,s.getNorth());o.lat=a}else if(r==="n"){a=Math.max(e.lat,s.getSouth());l.lat=a}else if(r==="e"){n=Math.max(e.lng,s.getWest());l.lng=n}else if(r==="w"){n=Math.min(e.lng,s.getEast());o.lng=n}else if(r==="nw"){n=Math.min(e.lng,s.getEast());a=Math.max(e.lat,s.getSouth());o.lng=n;l.lat=a}else if(r==="ne"){n=Math.max(e.lng,s.getWest());a=Math.max(e.lat,s.getSouth());l.lng=n;l.lat=a}else if(r==="se"){n=Math.max(e.lng,s.getWest());a=Math.min(e.lat,s.getNorth());l.lng=n;o.lat=a}this.rectangle_.setBounds(L.latLngBounds(o,l));if(this.getAngle()!==0){this.rotate_(this.rectangle_,this.getAngle(),this.getAnchor())}this.setAnchor(o);this.createOrUpdateControlFeatures_();this.rectangle_.fire("scale",{layer:this.rectangle_,anchor:this.anchor_})},onScaleEnd_:function(t){this.map_.off("mousemove",this._onScale,this).off("mouseup",this._onScaleEnd,this);this.rectangle_.fire("scaleend",{layer:this._rectangle})},hideHandlers_:function(){this.map_.removeLayer(this.controlFeatures_)},onTranslateStart_:function(t){var e=this.map_;e.dragging.disable();this.lastCoordinate_=t.latlng;this.map_.on("mousemove",this.onTranslate_,this).on("mouseup",this.onTranslateEnd_,this);this.rectangle_.fire("translatestart",{layer:this.rectangle_})},onTranslate_:function(t){var e=t.latlng;if(this.lastCoordinate_){var n=this.project_(e);var a=this.project_(this.lastCoordinate_);var r=new L.Point(n.x-a.x,n.y-a.y);this.translate_(this.rectangle_,r);var i=this.getAnchor();this.translate_(i,r);this.setAnchor(i);this.createOrUpdateControlFeatures_();this.lastCoordinate_=e}this.rectangle_.fire("translate",{layer:this.rectangle_,anchor:this.getAnchor()})},onTranslateEnd_:function(t){this.map_.off("mousemove",this._onTranslate,this).off("mouseup",this._onTranslateEnd,this);this.rectangle_.fire("translateend",{layer:this._rectangle});this.rectangle_.on("mousedown",this.onTranslateStart_,this)}});L.Path.addInitHook(function(){if(this.options.transform){this.transform=new L.Handler.RectangleTransform(this,this.options.transform)}});